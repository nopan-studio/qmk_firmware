/*
Copyright 2019 @foostan
Copyright 2020 Drashna Jaelre <@drashna>

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 2 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/

#include "quantum.h"

#ifdef SWAP_HANDS_ENABLE
__attribute__((weak)) const keypos_t PROGMEM hand_swap_config[MATRIX_ROWS][MATRIX_COLS] = {
    // Left
    {{0, 4}, {1, 4}, {2, 4}, {3, 4}, {4, 4}, {5, 4}},
    {{0, 5}, {1, 5}, {2, 5}, {3, 5}, {4, 5}, {5, 5}},
    {{0, 6}, {1, 6}, {2, 6}, {3, 6}, {4, 6}, {5, 6}},
    {{0, 7}, {1, 7}, {2, 7}, {3, 7}, {4, 7}, {5, 7}},
    // Right
    {{0, 0}, {1, 0}, {2, 0}, {3, 0}, {4, 0}, {5, 0}},
    {{0, 1}, {1, 1}, {2, 1}, {3, 1}, {4, 1}, {5, 1}},
    {{0, 2}, {1, 2}, {2, 2}, {3, 2}, {4, 2}, {5, 2}},
    {{0, 3}, {1, 3}, {2, 3}, {3, 3}, {4, 3}, {5, 3}}
};
#endif

#ifdef OLED_ENABLE
/*
Copyright 2019 @foostan
Copyright 2020 Drashna Jaelre <@drashna>

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 2 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/

// OLED setup
#define IDLE_FRAMES 5
#define IDLE_SPEED 30
#define TAP_FRAMES 2
#define TAP_SPEED 40
#define ANIM_FRAME_DURATION 200
#define ANIM_SIZE 512

bool gui_on = true;
char wpm_str[10];
uint32_t anim_timer = 0;
uint32_t anim_sleep = 0;
uint8_t current_idle_frame = 0;
uint8_t current_tap_frame = 0;

static long int oled_timeout = 1000000000; // 10 minutes

//
// Rotate OLED display
//
oled_rotation_t oled_init_user(oled_rotation_t rotation) {
	if (!is_keyboard_master()) return OLED_ROTATION_180;
    else return OLED_ROTATION_270; 
}

//
// Render left OLED display
//
static void render_status(void) {
    
    // WPM
    oled_write_P(PSTR("      "), false);
    oled_write_P(PSTR("    "), false);
    sprintf(wpm_str, "%03d", get_current_wpm());
    oled_write(wpm_str, false);
    oled_write_P(PSTR("  WPM \n \n"), false);
    oled_write_P(PSTR("      \n"), false);
    // Layer indicator
    oled_write_P(PSTR("LAYER"), false);
    oled_write_P(PSTR("      \n"), false);
    switch (get_highest_layer(default_layer_state)) {
        case 2:
        oled_write_P(PSTR("RAISE"), false);
        break;
    // Layer 1
        case 1:
            oled_write_P(PSTR("LOWER"), false);
            break;
        // Layer 0
        default:
            oled_write_P(PSTR("BASE "), false);
            break;
    }

}

//
// Render right OLED display animation
//
static void render_anim(void) {

    // Idle animation
    static const char PROGMEM idle[IDLE_FRAMES][ANIM_SIZE] = {

        {
            255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,127, 63, 63, 63, 63, 31, 15,  7,  3,  3,  3,  7, 15, 31,127,127,127,127,127,255,255,127,127, 63, 31, 31, 31, 63,127,255,255,255,255,255,255,255,255,255,127,127,255,255,255,255,255,255,255,255,255,255,255,255,127,127,255,255,255,255,255,255,255,255,255,127, 63, 31, 31, 31, 63,127,127,255,255,127,127,127,127,127, 31, 15,  7,  3,  3,  3,  7, 15, 31, 63, 63, 63,
        63,127,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,231,  3,  1,  0,  0,  0,  0,128,128,193,192,128,128,192,252,254,230,198,110,124,120, 64, 64,112,120, 24, 56,112, 96, 96, 96, 96,112,120, 88, 56, 48,  0,  0, 38, 35, 35,  1,128,  0,  1,131,  1,128,128,  0,  0,129,129,131,135,135,135,135,131,129,129,  0,  0,128,128,  1,131,  1,  0,128,  1, 35, 35, 38,  0,  0, 48, 56, 88,120,112, 96, 96, 96, 96,112, 56, 24,120,112, 64,
        64,120,124,110,198,230,254,252,192,128,128,192,193,128,128,  0,  0,  0,  0,  1,  3,231,255,255,255,255,255,255,255,255,255,255,255,255,255,255,231,192,128,  0,  0,  0,  0,  1,  1,131,  3,  1,  1,  3, 63,127,103, 99,118, 62, 30,  2,  2, 14, 30, 24, 28, 14,  6,  6,  6,  6, 14, 30, 26, 28, 12,  0,  0,100,196,196,128,  1,  0,128,193,128,  1,  1,  0,  0,129,129,193,225,225,225,225,193,129,129,  0,  0,  1,  1,128,193,128,  0,  1,128,196,196,100,  0,  0, 12, 28, 26, 30, 14,  6,  6,  6,  6, 14, 28, 24, 30, 14,  2, 
        2, 30, 62,118, 99,103,127, 63,  3,  1,  1,  3,131,  1,  1,  0,  0,  0, 
        
        5,255,255,255,255,255,255,255,255,255,255,
        },

        {
            255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,127, 63, 63, 63, 63, 31, 15,  7,  3,  3,  3,  7, 15, 31,127,127,127,127,127,255,255,127,127, 63, 31, 31, 31, 63,127,255,255,255,255,255,255,255,255,255,127,127,255,255,255,255,255,255,255,255,255,255,255,255,127,127,255,255,255,255,255,255,255,255,255,127, 63, 31, 31, 31, 63,127,127,255,255,127,127,127,127,127, 31, 15,  7,  3,  3,  3,  7, 15, 31, 63, 63, 63,
            63,127,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,231,  3,  1,  0,  0,  0,  0,128,128,193,192,128,128,192,252,254,230,198,110,124,120, 64, 64,112,120, 24, 56,112, 96, 96, 96, 96,112,120, 88, 56, 48,  0,  0, 38, 35, 35,  1,128,  0,  1,131,  1,128,128,  0,  0,129,129,131,135,135,135,135,131,129,129,  0,  0,128,128,  1,131,  1,  0,128,  1, 35, 35, 38,  0,  0, 48, 56, 88,120,112, 96, 96, 96, 96,112, 56, 24,120,112, 64,
            64,120,124,110,198,230,254,252,192,128,128,192,193,128,128,  0,  0,  0,  0,  1,  3,231,255,255,255,255,255,255,255,255,255,255,255,255,255,255,231,192,128,  0,  0,  0,  0,  1,  1,131,  3,  1,  1,  3, 63,127,103, 99,118, 62, 30,  2,  2, 14, 30, 24, 28, 14,  6,  6,  6,  6, 14, 30, 26, 28, 12,  0,  0,100,196,196,128,  1,  0,128,193,128,  1,  1,  0,  0,129,129,193,225,225,225,225,193,129,129,  0,  0,  1,  1,128,193,128,  0,  1,128,196,196,100,  0,  0, 12, 28, 26, 30, 14,  6,  6,  6,  6, 14, 28, 24, 30, 14,  2, 
            2, 30, 62,118, 99,103,127, 63,  3,  1,  1,  3,131,  1,  1,  0,  0,  0, 
            
            5,255,255,255,255,255,255,255,255,255,255,
        },

        {
            255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,127, 63, 63, 63, 63, 31, 15,  7,  3,  3,  3,  7, 15, 31,127,127,127,127,127,255,255,127,127, 63, 31, 31, 31, 63,127,255,255,255,255,255,255,255,255,255,127,127,255,255,255,255,255,255,255,255,255,255,255,255,127,127,255,255,255,255,255,255,255,255,255,127, 63, 31, 31, 31, 63,127,127,255,255,127,127,127,127,127, 31, 15,  7,  3,  3,  3,  7, 15, 31, 63, 63, 63,
        63,127,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,231,  3,  1,  0,  0,  0,  0,128,128,193,192,128,128,192,252,254,230,198,110,124,120, 64, 64,112,120, 24, 56,112, 96, 96, 96, 96,112,120, 88, 56, 48,  0,  0, 38, 35, 35,  1,128,  0,  1,131,  1,128,128,  0,  0,129,129,131,135,135,135,135,131,129,129,  0,  0,128,128,  1,131,  1,  0,128,  1, 35, 35, 38,  0,  0, 48, 56, 88,120,112, 96, 96, 96, 96,112, 56, 24,120,112, 64,
        64,120,124,110,198,230,254,252,192,128,128,192,193,128,128,  0,  0,  0,  0,  1,  3,231,255,255,255,255,255,255,255,255,255,255,255,255,255,255,231,192,128,  0,  0,  0,  0,  1,  1,131,  3,  1,  1,  3, 63,127,103, 99,118, 62, 30,  2,  2, 14, 30, 24, 28, 14,  6,  6,  6,  6, 14, 30, 26, 28, 12,  0,  0,100,196,196,128,  1,  0,128,193,128,  1,  1,  0,  0,129,129,193,225,225,225,225,193,129,129,  0,  0,  1,  1,128,193,128,  0,  1,128,196,196,100,  0,  0, 12, 28, 26, 30, 14,  6,  6,  6,  6, 14, 28, 24, 30, 14,  2, 
        2, 30, 62,118, 99,103,127, 63,  3,  1,  1,  3,131,  1,  1,  0,  0,  0, 
        
        5,255,255,255,255,255,255,255,255,255,255,
        },

        {
            255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,127, 63, 63, 63, 63, 31, 15,  7,  3,  3,  3,  7, 15, 31,127,127,127,127,127,255,255,127,127, 63, 31, 31, 31, 63,127,255,255,255,255,255,255,255,255,255,127,127,255,255,255,255,255,255,255,255,255,255,255,255,127,127,255,255,255,255,255,255,255,255,255,127, 63, 31, 31, 31, 63,127,127,255,255,127,127,127,127,127, 31, 15,  7,  3,  3,  3,  7, 15, 31, 63, 63, 63,
            63,127,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,231,  3,  1,  0,  0,  0,  0,128,128,193,192,128,128,192,252,254,230,198,110,124,120, 64, 64,112,120, 24, 56,112, 96, 96, 96, 96,112,120, 88, 56, 48,  0,  0, 38, 35, 35,  1,128,  0,  1,131,  1,128,128,  0,  0,129,129,131,135,135,135,135,131,129,129,  0,  0,128,128,  1,131,  1,  0,128,  1, 35, 35, 38,  0,  0, 48, 56, 88,120,112, 96, 96, 96, 96,112, 56, 24,120,112, 64,
            64,120,124,110,198,230,254,252,192,128,128,192,193,128,128,  0,  0,  0,  0,  1,  3,231,255,255,255,255,255,255,255,255,255,255,255,255,255,255,231,192,128,  0,  0,  0,  0,  1,  1,131,  3,  1,  1,  3, 63,127,103, 99,118, 62, 30,  2,  2, 14, 30, 24, 28, 14,  6,  6,  6,  6, 14, 30, 26, 28, 12,  0,  0,100,196,196,128,  1,  0,128,193,128,  1,  1,  0,  0,129,129,193,225,225,225,225,193,129,129,  0,  0,  1,  1,128,193,128,  0,  1,128,196,196,100,  0,  0, 12, 28, 26, 30, 14,  6,  6,  6,  6, 14, 28, 24, 30, 14,  2, 
            2, 30, 62,118, 99,103,127, 63,  3,  1,  1,  3,131,  1,  1,  0,  0,  0, 
            
            5,255,255,255,255,255,255,255,255,255,255,
        },

        {
            255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,127, 63, 63, 63, 63, 31, 15,  7,  3,  3,  3,  7, 15, 31,127,127,127,127,127,255,255,127,127, 63, 31, 31, 31, 63,127,255,255,255,255,255,255,255,255,255,127,127,255,255,255,255,255,255,255,255,255,255,255,255,127,127,255,255,255,255,255,255,255,255,255,127, 63, 31, 31, 31, 63,127,127,255,255,127,127,127,127,127, 31, 15,  7,  3,  3,  3,  7, 15, 31, 63, 63, 63,
            63,127,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,231,  3,  1,  0,  0,  0,  0,128,128,193,192,128,128,192,252,254,230,198,110,124,120, 64, 64,112,120, 24, 56,112, 96, 96, 96, 96,112,120, 88, 56, 48,  0,  0, 38, 35, 35,  1,128,  0,  1,131,  1,128,128,  0,  0,129,129,131,135,135,135,135,131,129,129,  0,  0,128,128,  1,131,  1,  0,128,  1, 35, 35, 38,  0,  0, 48, 56, 88,120,112, 96, 96, 96, 96,112, 56, 24,120,112, 64,
            64,120,124,110,198,230,254,252,192,128,128,192,193,128,128,  0,  0,  0,  0,  1,  3,231,255,255,255,255,255,255,255,255,255,255,255,255,255,255,231,192,128,  0,  0,  0,  0,  1,  1,131,  3,  1,  1,  3, 63,127,103, 99,118, 62, 30,  2,  2, 14, 30, 24, 28, 14,  6,  6,  6,  6, 14, 30, 26, 28, 12,  0,  0,100,196,196,128,  1,  0,128,193,128,  1,  1,  0,  0,129,129,193,225,225,225,225,193,129,129,  0,  0,  1,  1,128,193,128,  0,  1,128,196,196,100,  0,  0, 12, 28, 26, 30, 14,  6,  6,  6,  6, 14, 28, 24, 30, 14,  2, 
            2, 30, 62,118, 99,103,127, 63,  3,  1,  1,  3,131,  1,  1,  0,  0,  0, 
            
            5,255,255,255,255,255,255,255,255,255,255,
        }

    };

    // Prep animation
    static const char PROGMEM prep[][ANIM_SIZE] = {

        {
            255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,127, 63, 63, 63, 63, 31, 15,  7,  3,  3,  3,  7, 15, 31,127,127,127,127,127,255,255,127,127, 63, 31, 31, 31, 63,127,255,255,255,255,255,255,255,255,255,127,127,255,255,255,255,255,255,255,255,255,255,255,255,127,127,255,255,255,255,255,255,255,255,255,127, 63, 31, 31, 31, 63,127,127,255,255,127,127,127,127,127, 31, 15,  7,  3,  3,  3,  7, 15, 31, 63, 63, 63,
            63,127,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,231,  3,  1,  0,  0,  0,  0,128,128,193,192,128,128,192,252,254,230,198,110,124,120, 64, 64,112,120, 24, 56,112, 96, 96, 96, 96,112,120, 88, 56, 48,  0,  0, 38, 35, 35,  1,128,  0,  1,131,  1,128,128,  0,  0,129,129,131,135,135,135,135,131,129,129,  0,  0,128,128,  1,131,  1,  0,128,  1, 35, 35, 38,  0,  0, 48, 56, 88,120,112, 96, 96, 96, 96,112, 56, 24,120,112, 64,
            64,120,124,110,198,230,254,252,192,128,128,192,193,128,128,  0,  0,  0,  0,  1,  3,231,255,255,255,255,255,255,255,255,255,255,255,255,255,255,231,192,128,  0,  0,  0,  0,  1,  1,131,  3,  1,  1,  3, 63,127,103, 99,118, 62, 30,  2,  2, 14, 30, 24, 28, 14,  6,  6,  6,  6, 14, 30, 26, 28, 12,  0,  0,100,196,196,128,  1,  0,128,193,128,  1,  1,  0,  0,129,129,193,225,225,225,225,193,129,129,  0,  0,  1,  1,128,193,128,  0,  1,128,196,196,100,  0,  0, 12, 28, 26, 30, 14,  6,  6,  6,  6, 14, 28, 24, 30, 14,  2, 
            2, 30, 62,118, 99,103,127, 63,  3,  1,  1,  3,131,  1,  1,  0,  0,  0, 
            
            5,255,255,255,255,255,255,255,255,255,255,
        }

    };

    // Typing animation
    static const char PROGMEM tap[TAP_FRAMES][ANIM_SIZE] = {

        {
            255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,127, 63, 63, 63, 63, 31, 15,  7,  3,  3,  3,  7, 15, 31,127,127,127,127,127,255,255,127,127, 63, 31, 31, 31, 63,127,255,255,255,255,255,255,255,255,255,127,127,255,255,255,255,255,255,255,255,255,255,255,255,127,127,255,255,255,255,255,255,255,255,255,127, 63, 31, 31, 31, 63,127,127,255,255,127,127,127,127,127, 31, 15,  7,  3,  3,  3,  7, 15, 31, 63, 63, 63,
        63,127,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,231,  3,  1,  0,  0,  0,  0,128,128,193,192,128,128,192,252,254,230,198,110,124,120, 64, 64,112,120, 24, 56,112, 96, 96, 96, 96,112,120, 88, 56, 48,  0,  0, 38, 35, 35,  1,128,  0,  1,131,  1,128,128,  0,  0,129,129,131,135,135,135,135,131,129,129,  0,  0,128,128,  1,131,  1,  0,128,  1, 35, 35, 38,  0,  0, 48, 56, 88,120,112, 96, 96, 96, 96,112, 56, 24,120,112, 64,
        64,120,124,110,198,230,254,252,192,128,128,192,193,128,128,  0,  0,  0,  0,  1,  3,231,255,255,255,255,255,255,255,255,255,255,255,255,255,255,231,192,128,  0,  0,  0,  0,  1,  1,131,  3,  1,  1,  3, 63,127,103, 99,118, 62, 30,  2,  2, 14, 30, 24, 28, 14,  6,  6,  6,  6, 14, 30, 26, 28, 12,  0,  0,100,196,196,128,  1,  0,128,193,128,  1,  1,  0,  0,129,129,193,225,225,225,225,193,129,129,  0,  0,  1,  1,128,193,128,  0,  1,128,196,196,100,  0,  0, 12, 28, 26, 30, 14,  6,  6,  6,  6, 14, 28, 24, 30, 14,  2, 
        2, 30, 62,118, 99,103,127, 63,  3,  1,  1,  3,131,  1,  1,  0,  0,  0, 
        
        5,255,255,255,255,255,255,255,255,255,255,
        },

        {
            255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,127, 63, 63, 63, 63, 31, 15,  7,  3,  3,  3,  7, 15, 31,127,127,127,127,127,255,255,127,127, 63, 31, 31, 31, 63,127,255,255,255,255,255,255,255,255,255,127,127,255,255,255,255,255,255,255,255,255,255,255,255,127,127,255,255,255,255,255,255,255,255,255,127, 63, 31, 31, 31, 63,127,127,255,255,127,127,127,127,127, 31, 15,  7,  3,  3,  3,  7, 15, 31, 63, 63, 63,
        63,127,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,231,  3,  1,  0,  0,  0,  0,128,128,193,192,128,128,192,252,254,230,198,110,124,120, 64, 64,112,120, 24, 56,112, 96, 96, 96, 96,112,120, 88, 56, 48,  0,  0, 38, 35, 35,  1,128,  0,  1,131,  1,128,128,  0,  0,129,129,131,135,135,135,135,131,129,129,  0,  0,128,128,  1,131,  1,  0,128,  1, 35, 35, 38,  0,  0, 48, 56, 88,120,112, 96, 96, 96, 96,112, 56, 24,120,112, 64,
        64,120,124,110,198,230,254,252,192,128,128,192,193,128,128,  0,  0,  0,  0,  1,  3,231,255,255,255,255,255,255,255,255,255,255,255,255,255,255,231,192,128,  0,  0,  0,  0,  1,  1,131,  3,  1,  1,  3, 63,127,103, 99,118, 62, 30,  2,  2, 14, 30, 24, 28, 14,  6,  6,  6,  6, 14, 30, 26, 28, 12,  0,  0,100,196,196,128,  1,  0,128,193,128,  1,  1,  0,  0,129,129,193,225,225,225,225,193,129,129,  0,  0,  1,  1,128,193,128,  0,  1,128,196,196,100,  0,  0, 12, 28, 26, 30, 14,  6,  6,  6,  6, 14, 28, 24, 30, 14,  2, 
        2, 30, 62,118, 99,103,127, 63,  3,  1,  1,  3,131,  1,  1,  0,  0,  0, 
        
        5,255,255,255,255,255,255,255,255,255,255,
        }

    };

    void animation_phase(void) {

        if (get_current_wpm() <=IDLE_SPEED) {
            current_idle_frame = (current_idle_frame + 1) % IDLE_FRAMES;
            oled_write_raw_P(idle[abs((IDLE_FRAMES-1)-current_idle_frame)], ANIM_SIZE);
        }

        if (get_current_wpm() >IDLE_SPEED && get_current_wpm() <TAP_SPEED) {
            oled_write_raw_P(prep[0], ANIM_SIZE);
        }

        if (get_current_wpm() >=TAP_SPEED) {
            current_tap_frame = (current_tap_frame + 1) % TAP_FRAMES;
            oled_write_raw_P(tap[abs((TAP_FRAMES-1)-current_tap_frame)], ANIM_SIZE);
        }
    }

    if (get_current_wpm() != 000) {
        oled_on();

        if (timer_elapsed32(anim_timer) > ANIM_FRAME_DURATION) {
            anim_timer = timer_read32();
            animation_phase();
        }

        anim_sleep = timer_read32();
    } else {
        if (timer_elapsed32(anim_sleep) > oled_timeout) {
            //oled_off();
        } else {
            if (timer_elapsed32(anim_timer) > ANIM_FRAME_DURATION) {
                anim_timer = timer_read32();
                animation_phase();
            }
        }
    }
}

//
// OLED display rendering
//
bool oled_task_user(void) {
    if (is_keyboard_master()) {
        // Left side
        render_status();
    } else {
        // Right side
        render_anim();
    }
  return true;
}
#endif // OLED_ENABLE
